# Spec: 微信一键登录功能

**能力 ID**: `one-tap-login`  
**版本**: 1.0.0  
**状态**: 草稿

## ADDED Requirements

### Requirement: 微信手机号授权触发
**ID**: `OTL-REQ-001`  
**优先级**: 必须  
**类型**: 功能性

用户必须能够通过点击按钮触发微信手机号授权。

#### Scenario: 用户点击一键登录按钮触发授权
**Given** 用户处于登录页面  
**When** 用户点击"一键登录"按钮  
**Then** 触发微信手机号授权弹窗  
**And** 按钮显示加载状态

#### Scenario: 授权弹窗正确显示
**Given** 微信手机号授权被触发  
**When** 授权弹窗显示  
**Then** 弹窗包含明确的授权说明  
**And** 弹窗包含"允许"和"拒绝"两个选项

---

### Requirement: 授权成功后自动登录
**ID**: `OTL-REQ-002`  
**优先级**: 必须  
**类型**: 功能性

用户授权成功后，系统必须自动获取用户信息并完成登录。

#### Scenario: 用户同意授权后自动登录
**Given** 用户点击了"一键登录"按钮  
**When** 用户在授权弹窗中点击"允许"  
**Then** 系统获取encryptedData和iv  
**And** 调用login API传递加密数据  
**And** 后端解密获取手机号  
**And** 获取微信用户头像和昵称  
**And** 自动完成登录并保存用户信息  
**And** 显示"登录成功"提示  
**And** 跳转到主页或继续上次游戏

#### Scenario: 授权成功但API调用失败
**Given** 用户授权成功  
**When** login API调用失败（网络异常或后端错误）  
**Then** 显示错误提示"登录失败，请重试"  
**And** 提供重试按钮  
**And** 不清除已获取的授权信息

---

### Requirement: 授权失败处理
**ID**: `OTL-REQ-003`  
**优先级**: 必须  
**类型**: 功能性

用户拒绝授权或授权失败时，必须提供友好的降级方案。

#### Scenario: 用户拒绝授权时显示自定义登录
**Given** 用户点击了"一键登录"按钮  
**When** 用户在授权弹窗中点击"拒绝"  
**Then** 授权弹窗关闭  
**And** 自动显示自定义登录表单  
**And** 显示引导文案"您可以通过自定义方式登录"  
**And** 不再自动触发授权

#### Scenario: 授权超时时提供重试选项
**Given** 用户点击了"一键登录"按钮  
**When** 授权请求超过10秒未响应  
**Then** 显示"授权超时"提示  
**And** 提供"重试"按钮  
**And** 提供"自定义登录"链接

#### Scenario: 授权接口异常时降级
**Given** 用户点击了"一键登录"按钮  
**When** 微信授权接口返回错误  
**Then** 显示"授权失败"提示  
**And** 自动显示自定义登录表单  
**And** 记录错误日志

---

### Requirement: 自定义登录降级方案
**ID**: `OTL-REQ-004`  
**优先级**: 必须  
**类型**: 功能性

必须保留自定义登录方式作为降级方案。

#### Scenario: 自定义登录表单正常显示
**Given** 用户拒绝了一键登录授权  
**When** 自定义登录表单显示  
**Then** 表单包含头像选择按钮  
**And** 表单包含昵称输入框  
**And** 表单包含"开始游戏"按钮  
**And** 表单包含引导文案

#### Scenario: 自定义登录正常工作
**Given** 用户在自定义登录表单中  
**When** 用户选择头像并输入昵称  
**And** 用户点击"开始游戏"  
**Then** 验证昵称格式（2-10字符）  
**And** 调用login API传递头像和昵称  
**And** 登录成功后保存用户信息  
**And** 跳转到主页

#### Scenario: 用户可主动切换到自定义登录
**Given** 用户处于一键登录页面  
**When** 用户点击"使用其他方式登录"链接  
**Then** 显示自定义登录表单  
**And** 不触发授权请求

---

### Requirement: 加载状态反馈
**ID**: `OTL-REQ-005`  
**优先级**: 必须  
**类型**: 用户体验

系统必须在关键操作时提供清晰的加载状态反馈。

#### Scenario: 授权中显示加载状态
**Given** 用户点击了"一键登录"按钮  
**When** 等待授权结果期间  
**Then** 按钮显示加载动画  
**And** 按钮文本变为"授权中..."  
**And** 按钮禁用，不可再次点击

#### Scenario: 登录API调用时显示加载状态
**Given** 授权成功，正在调用login API  
**When** 等待API响应期间  
**Then** 显示全屏加载遮罩  
**And** 显示"登录中..."文本  
**And** 页面其他操作被禁用

#### Scenario: 加载完成后恢复正常状态
**Given** 加载状态正在显示  
**When** 操作完成（成功或失败）  
**Then** 移除加载状态  
**And** 恢复按钮可点击状态  
**And** 显示操作结果（成功或错误提示）

---

### Requirement: 错误提示友好性
**ID**: `OTL-REQ-006`  
**优先级**: 应该  
**类型**: 用户体验

所有错误场景必须提供友好、清晰的错误提示。

#### Scenario: 网络异常时提示明确
**Given** 用户已授权成功  
**When** login API因网络异常失败  
**Then** 显示"网络连接异常，请检查网络后重试"  
**And** 提供"重试"按钮  
**And** 错误提示在3秒后自动消失

#### Scenario: 后端错误时提示具体信息
**Given** 用户已授权成功  
**When** login API返回后端错误  
**Then** 显示API返回的具体错误消息  
**And** 提供"重试"或"自定义登录"选项  
**And** 错误提示不自动消失，需用户手动关闭

#### Scenario: 解密失败时提供降级方案
**Given** 用户已授权成功  
**When** 后端无法解密手机号  
**Then** 显示"授权信息处理失败"  
**And** 自动显示自定义登录表单  
**And** 提示用户使用自定义方式登录

---

### Requirement: 用户信息正确性
**ID**: `OTL-REQ-007`  
**优先级**: 必须  
**类型**: 功能性

通过一键登录获取的用户信息必须完整且正确。

#### Scenario: 成功获取手机号
**Given** 用户授权成功且后端解密成功  
**When** 登录完成  
**Then** 用户信息中包含完整的手机号  
**And** 手机号格式正确（11位数字）  
**And** 手机号已脱敏存储

#### Scenario: 成功获取头像和昵称
**Given** 用户授权成功  
**When** 获取微信用户信息  
**Then** 用户信息中包含微信头像URL  
**And** 用户信息中包含微信昵称  
**And** 头像URL可正常访问  
**And** 昵称非空且长度合理

#### Scenario: 默认值处理
**Given** 无法获取部分用户信息  
**When** 登录完成  
**Then** 使用默认头像替代缺失的头像  
**And** 使用"游戏玩家"替代缺失的昵称  
**And** 手机号为空时不影响登录

---

### Requirement: 本地存储持久化
**ID**: `OTL-REQ-008`  
**优先级**: 必须  
**类型**: 功能性

登录成功后必须将用户信息持久化到本地存储。

#### Scenario: 登录成功后保存用户信息
**Given** 用户通过一键登录成功  
**When** 登录API返回用户数据  
**Then** 调用setUserInfo保存到本地存储  
**And** 存储包含userId、name、avatar、phone等字段  
**And** 存储加密敏感信息（如手机号）  
**And** 下次打开小程序时可以读取存储的信息

#### Scenario: 静默登录检查
**Given** 用户已登录过  
**When** 再次打开小程序  
**Then** 检查本地存储中的用户信息  
**And** 如果存在有效用户信息，直接进入主页  
**And** 不需要再次登录

---

### Requirement: 授权说明清晰
**ID**: `OTL-REQ-009`  
**优先级**: 应该  
**类型**: 用户体验

必须向用户清晰说明授权的用途和隐私保护措施。

#### Scenario: 授权前显示说明文案
**Given** 用户即将点击一键登录  
**When** 一键登录按钮附近  
**Then** 显示简短的授权说明  
**And** 说明文案包含"获取手机号用于账号注册"  
**And** 说明文案包含隐私保护承诺  
**And** 文案简洁易懂，不超过20字

#### Scenario: 授权弹窗包含详细说明
**Given** 微信授权弹窗显示  
**When** 用户查看弹窗内容  
**Then** 弹窗包含明确的授权范围  
**And** 弹窗说明数据用途  
**And** 弹窗提示可以拒绝授权

---

## MODIFIED Requirements

### Requirement: 登录API接口增强
**ID**: `OTL-REQ-MOD-001`  
**优先级**: 必须  
**类型**: 功能性

登录API需要支持一键登录和自定义登录两种方式。

#### Scenario: API支持快速登录参数
**Given** 前端调用login API  
**When** 传递loginType='quick'  
**Then** API接受encryptedData和iv参数  
**And** 后端解密获取手机号  
**And** 自动查询或创建用户  
**And** 返回完整用户信息

#### Scenario: API支持自定义登录参数
**Given** 前端调用login API  
**When** 传递loginType='custom'  
**Then** API接受name和avatar参数  
**And** 使用自定义信息创建用户  
**And** 返回完整用户信息

---

## REMOVED Requirements

无

---

## 相关能力
- `visual-enhancement`: 视觉优化需要与一键登录按钮风格统一
- `error-handling`: 错误处理机制需要覆盖授权失败场景

---

## 实现注意事项
1. 必须在真机上测试，开发工具无法完全模拟授权流程
2. 手机号解密需要后端支持，确保后端已实现相关接口
3. 授权失败时不要反复弹出授权请求，避免打扰用户
4. 保护用户隐私，手机号需要脱敏存储和显示
5. 考虑网络异常场景，提供离线缓存机制
6. 记录关键操作日志，便于排查问题
7. 遵守微信小程序平台规范，不违规使用用户信息
