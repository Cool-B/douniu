# 提案：优化游戏房间操作方法

## 变更 ID
`optimize-room-operations`

## 动机
当前游戏房间的核心操作方法（下注、添加机器人/换座位）存在以下问题：
1. 数据验证不完整，缺少边界条件检查
2. 业务规则验证不严格，可能导致非法操作
3. 错误提示不够明确，用户体验不佳
4. 命名不够语义化，代码可读性差

## 目标
优化 `changeBet` 和 `addAssistantOrChangeSeat` 两个核心方法，使其具有：
- 完整的参数验证和边界条件检查
- 严格的业务规则验证
- 清晰的错误提示和日志记录
- 良好的代码可读性和可维护性

## 范围

### 包含
1. **changeBet 方法优化**
   - 完善参数验证（roomId, userId, bet）
   - 添加业务规则验证（庄家限制、状态限制、游戏状态限制、范围限制）
   - 实现数据持久化
   - 添加详细日志

2. **addAssistantOrChangeSeat 方法优化**
   - 支持双重功能：庄家添加机器人 + 玩家换座位
   - 完善参数验证（roomId, userId, seatIndex, isBanker）
   - 添加通用验证规则和分支特定验证规则
   - 实现座位交换逻辑
   - 添加详细日志

3. **前端调用优化**
   - 更新 API 接口定义
   - 优化前端调用逻辑
   - 改善用户反馈提示

### 不包含
- 其他房间操作方法的优化（如 playerReady, exitRoom 等）
- UI/UX 的大幅改动
- 游戏核心逻辑的变更

## 影响分析

### 破坏性变更
- `addAssistantOrChangeSeat` API 签名变更：新增 `userId` 参数

### 受影响的组件
- `utils/mockData.ts` - Mock API 实现
- `api/index.ts` - API 接口定义
- `pages/card_game/card_game.ts` - 前端调用逻辑

### 依赖关系
- 依赖现有的 `roomInfo` 数据结构
- 依赖 `setRoomInfo` 本地存储方法

## 实施策略
1. 按方法独立优化，先 `changeBet` 后 `addAssistantOrChangeSeat`
2. 保持向后兼容，确保前端调用正确更新
3. 添加详细的日志记录便于调试
4. 每个方法优化后进行充分测试

## 验证计划
1. **单元测试**（手动验证）
   - 参数验证测试（缺失参数、无效参数）
   - 边界条件测试（座位索引、下注范围）
   - 业务规则测试（权限、状态、游戏阶段）

2. **集成测试**（手动验证）
   - 庄家添加机器人流程
   - 玩家换座位流程
   - 玩家下注流程
   - 错误场景处理

3. **用户验收测试**
   - 创建房间并测试完整流程
   - 验证错误提示的清晰度
   - 验证数据持久化正确性

## 成功标准
- ✅ 所有参数验证和业务规则检查通过
- ✅ 错误场景有明确的错误提示
- ✅ 数据正确保存到本地存储
- ✅ 前端调用正常，用户反馈清晰
- ✅ 代码具有良好的可读性和可维护性

## 风险评估
- **低风险**：主要是逻辑优化，不涉及数据结构变更
- **中风险**：API 签名变更需要确保前端同步更新
- **缓解措施**：充分的手动测试和逐步部署

## 替代方案
1. **渐进式优化**：先优化验证逻辑，后续再优化命名和结构
2. **重写方法**：完全重新设计方法架构
3. **当前方案（推荐）**：在现有基础上优化，保持向后兼容

## 时间估计
- 设计和规划：0.5 小时
- 实施开发：1 小时
- 测试和验证：0.5 小时
- 总计：2 小时

## 相关资源
- 项目需求文档：`项目需求文档-功能需求.md`
- API 文档：`项目需求文档-数据模型与API.md`
- 现有实现：`utils/mockData.ts`
