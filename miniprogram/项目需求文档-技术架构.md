# 斗牛扑克游戏 - 技术架构文档

## 1. 整体架构设计

### 1.1 架构模式

本项目采用 **分层架构 + 组件化** 的设计模式:

```
┌─────────────────────────────────────────────────────┐
│                  表现层 (Presentation)               │
│  ┌──────────────┐  ┌──────────────┐                │
│  │   Pages      │  │  Components  │                │
│  │  (页面组件)   │  │  (可复用组件)  │                │
│  └──────────────┘  └──────────────┘                │
└────────────────┬────────────────────────────────────┘
                 │
┌────────────────┴────────────────────────────────────┐
│                  业务逻辑层 (Business)                │
│  ┌──────────────┐  ┌──────────────┐                │
│  │  Game Logic  │  │  Utils       │                │
│  │  (游戏逻辑)    │  │  (工具函数)   │                │
│  └──────────────┘  └──────────────┘                │
└────────────────┬────────────────────────────────────┘
                 │
┌────────────────┴────────────────────────────────────┐
│                  数据访问层 (Data Access)             │
│  ┌──────────────┐  ┌──────────────┐                │
│  │  API Service │  │ LocalStorage │                │
│  │  (接口服务)   │  │  (本地存储)   │                │
│  └──────────────┘  └──────────────┘                │
└────────────────┬────────────────────────────────────┘
                 │
┌────────────────┴────────────────────────────────────┐
│                  后端服务 (Backend)                   │
│  ┌──────────────┐  ┌──────────────┐                │
│  │  REST API    │  │  WebSocket   │                │
│  │              │  │  (实时通信)   │                │
│  └──────────────┘  └──────────────┘                │
└─────────────────────────────────────────────────────┘
```

### 1.2 技术栈总览

| 层次 | 技术 | 说明 |
|------|------|------|
| **前端框架** | WeChat MiniProgram | 微信小程序原生框架 |
| **组件框架** | Glass-Easel | 微信官方高性能组件框架 |
| **编程语言** | TypeScript | 类型安全的JavaScript超集 |
| **样式预处理** | LESS | CSS预处理器 |
| **网络请求** | Axios | HTTP客户端库 |
| **状态管理** | LocalStorage + Page Data | 本地存储+页面状态 |
| **后端语言** | (待定) Node.js / Java / Go | 根据团队技术栈选择 |
| **实时通信** | WebSocket | 双向实时通信 |
| **数据库** | (待定) MySQL / MongoDB | 关系型或文档型数据库 |

---

## 2. 前端架构详解

### 2.1 目录结构

```
miniprogram/
├── pages/                      # 页面目录
│   ├── index/                  # 主页/登录页
│   │   ├── index.ts            # 页面逻辑
│   │   ├── index.wxml          # 页面模板
│   │   ├── index.less          # 页面样式
│   │   └── index.json          # 页面配置
│   └── card_game/              # 游戏页
│       ├── card_game.ts
│       ├── card_game.wxml
│       ├── card_game.less
│       └── card_game.json
│
├── components/                 # 组件目录
│   ├── room-modal/             # 房间号输入模态框
│   │   ├── room-modal.ts
│   │   ├── room-modal.wxml
│   │   ├── room-modal.less
│   │   └── room-modal.json
│   └── rules-modal/            # 规则说明模态框
│       ├── rules-modal.ts
│       ├── rules-modal.wxml
│       ├── rules-modal.less
│       └── rules-modal.json
│
├── api/                        # API接口定义
│   └── index.ts                # API函数导出
│
├── utils/                      # 工具函数
│   ├── request.ts              # 网络请求封装
│   ├── mockData.ts             # Mock数据生成
│   ├── localStorage.ts         # 本地存储封装
│   ├── game.ts                 # 游戏逻辑工具
│   ├── util.ts                 # 通用工具函数
│   └── interface.ts            # 接口定义
│
├── typings/                    # TypeScript类型定义
│   └── index.ts                # 类型导出
│
├── assets/                     # 静态资源
│   └── poke/                   # 扑克牌图片
│       ├── Spade/              # 黑桃
│       ├── Heart/              # 红桃
│       ├── Club/               # 梅花
│       └── Diamond/            # 方块
│
├── app.ts                      # 小程序入口逻辑
├── app.json                    # 小程序全局配置
├── app.less                    # 全局样式
├── sitemap.json                # 搜索引擎配置
├── project.config.json         # 项目配置
└── package.json                # 依赖管理
```

### 2.2 页面架构

#### 2.2.1 Index页面 (登录/主页)

**文件位置**: `pages/index/`

**职责**:
- 用户登录与注册
- 显示用户信息
- 游戏模式选择
- 房间创建/加入

**数据模型**:
```typescript
interface IndexPageData {
  userInfo: userInfo;           // 用户信息
  isLogin: boolean;             // 登录状态
  errorMessage: string;         // 错误提示
  loading: boolean;             // 加载状态
  modalVisible: boolean;        // 模态框可见性
  rulesVisible: boolean;        // 规则模态框
}
```

**生命周期**:
```typescript
onLoad() {
  // 检查本地存储的登录状态
  const userInfo = getUserInfo()
  if (userInfo) {
    this.setData({ isLogin: true, userInfo })
  }
}

onShow() {
  // 检查是否需要重新加载
}
```

#### 2.2.2 CardGame页面 (游戏页)

**文件位置**: `pages/card_game/`

**职责**:
- 显示游戏房间信息
- 玩家座位管理
- 游戏流程控制(洗牌、发牌、结算)
- 玩家操作(下注、准备、看牌)

**数据模型**:
```typescript
interface CardGamePageData {
  roomInfo: roomInfo;           // 房间信息
  currentUserInfo: userInfo;    // 当前用户
  currentUser: 'banker'|'player'; // 当前角色
  pokers: poke[];               // 牌堆
  playerNumber: playerNumber[]; // 玩家座位
  selectedValue: number;        // 选择的下注倍数
  isReady: boolean;             // 是否已准备
  isAllShow: boolean;           // 是否全部亮牌
  range: number[];              // 下注范围[1-10]
}
```

**关键方法**:
```typescript
// 游戏流程控制
shufflePoke()        // 洗牌
dealCards()          // 发牌
startGame()          // 开始游戏
settlementCurrent()  // 结算

// 玩家操作
changeReady()        // 准备/取消准备
checkPokes()         // 查看手牌
addAssistant()       // 添加机器人
goOut()              // 退出房间

// 牌型识别
getMaxPoint()        // 计算最大牛点
isBoom()             // 判断炸弹
isBothTen()          // 判断双十
```

### 2.3 组件架构

#### 2.3.1 组件设计原则

1. **单一职责**: 每个组件只负责一个功能
2. **高内聚低耦合**: 组件内部逻辑完整,对外接口简洁
3. **可复用性**: 组件可在多个页面中使用
4. **通过事件通信**: 组件通过triggerEvent向父组件传递数据

#### 2.3.2 RoomModal组件

**功能**: 房间号输入模态框

**Props**:
```typescript
properties: {
  visible: {
    type: Boolean,
    value: false
  },
  title: {
    type: String,
    value: '加入游戏'
  },
  placeholder: {
    type: String,
    value: '请输入房间号'
  },
  showQuickStart: {
    type: Boolean,
    value: false
  }
}
```

**Events**:
```typescript
triggerEvent('confirm', { roomNumber: string })  // 确认加入
triggerEvent('cancel')                            // 取消
triggerEvent('close')                             // 关闭
triggerEvent('quickStart')                        // 快速开始
```

**使用示例**:
```xml
<room-modal 
  visible="{{modalVisible}}"
  title="加入游戏"
  showQuickStart="{{true}}"
  bind:confirm="handleJoinRoom"
  bind:cancel="handleCancel"
  bind:close="handleClose"
  bind:quickStart="handleQuickStart">
</room-modal>
```

#### 2.3.3 RulesModal组件

**功能**: 游戏规则说明模态框

**Props**:
```typescript
properties: {
  visible: {
    type: Boolean,
    value: false
  }
}
```

**Events**:
```typescript
triggerEvent('close')  // 关闭
```

---

## 3. 数据层架构

### 3.1 数据流设计

```
用户操作 
  ↓
页面事件处理器
  ↓
调用API Service
  ↓
request.ts路由判断
  ↓
┌─────────────┬─────────────┐
│  Mock API   │  Real API   │
│  (本地模拟)  │  (后端服务)  │
└─────────────┴─────────────┘
  ↓
响应数据
  ↓
更新LocalStorage (持久化)
  ↓
更新Page Data (响应式)
  ↓
UI重新渲染
```

### 3.2 API服务层

**文件**: `api/index.ts`

**设计模式**: 服务定位模式 (Service Locator)

**接口定义**:
```typescript
// 用户相关
export function login(code: string, name: string, avatar: string): Promise<ResponseResult<userInfo>>

// 房间相关
export function createRoom(userId: number, roomType: number): Promise<ResponseResult<{roomInfo: roomInfo}>>
export function joinRoom(userId: number, roomNumber: string): Promise<ResponseResult<{roomInfo: roomInfo}>>
export function getRoomInfo(roomId: number): Promise<ResponseResult<{roomInfo: roomInfo}>>
export function exitRoom(roomId: number, userId: number): Promise<ResponseResult<any>>

// 游戏相关
export function startGame(roomId: number, userId: number): Promise<ResponseResult<any>>
export function gameAction(gameId: string, userId: number, action: string, round?: number): Promise<ResponseResult<any>>
export function assAssistant(roomId: number, seatIndex: number): Promise<ResponseResult<any>>
```

### 3.3 请求层封装

**文件**: `utils/request.ts`

**职责**:
- 统一请求入口
- 请求/响应拦截
- 错误处理
- Mock数据路由

**实现**:
```typescript
export default function request<T>(options: RequestOptions): Promise<ResponseResult<T>> {
  const { url, data, method = 'POST', header = {} } = options;
  
  console.log('=== API Request ===');
  console.log('URL:', url);
  console.log('Method:', method);
  console.log('Data:', data);
  
  // 路由到Mock API (开发阶段)
  switch (url) {
    case '/api/wx/user/login':
      return mockApi.login(data) as Promise<ResponseResult<T>>;
    case '/poker/createRoom':
      return mockApi.createRoom(data) as Promise<ResponseResult<T>>;
    case '/poker/joinRoom':
      return mockApi.joinRoom(data) as Promise<ResponseResult<T>>;
    // ... 其他路由
    default:
      return Promise.reject({ code: 404, msg: '接口不存在', data: null });
  }
  
  // 真实API请求 (生产阶段)
  // return wx.request({ ... })
}
```

### 3.4 本地存储层

**文件**: `utils/localStorage.ts`

**存储策略**:
- 用户信息: 持久化存储,用于自动登录
- 房间信息: 会话存储,支持多房间
- 设置项: 持久化存储

**API设计**:
```typescript
// 用户信息
export function setUserInfo(userInfo: userInfo): void
export function getUserInfo(): userInfo | ''
export function removeUserInfo(): void

// 房间信息
export function setRoomInfo(roomInfo: roomInfo): void
export function getRoomInfo(): roomInfo[]
export function removeRoomInfo(): void

// 清空所有或指定房间
export function removeAll(roomId?: number): void
```

**存储格式**:
```typescript
// 键: 'setUserInfo'
{
  "id": 1001,
  "name": "玩家一号",
  "avatar": "https://...",
  "openid": "...",
  "token": "..."
}

// 键: 'roomInfo'
[
  {
    "roomId": 1703056000123,
    "roomNumber": 456789,
    "players": [...],
    ...
  }
]
```

---

## 4. 业务逻辑层

### 4.1 游戏逻辑模块

#### 4.1.1 洗牌算法

**算法**: Fisher-Yates Shuffle (现代版)

**时间复杂度**: O(n)

**实现**:
```typescript
function shuffleArray(): poke[] {
  const suits = ['Spade', 'Heart', 'Club', 'Diamond'];
  const cards: poke[] = [];
  
  // 生成52张牌
  for (let number = 1; number <= 13; number++) {
    for (const suit of suits) {
      cards.push({ suit, number });
    }
  }
  
  // Fisher-Yates洗牌
  for (let i = cards.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [cards[i], cards[j]] = [cards[j], cards[i]];
  }
  
  return cards;
}
```

**优点**:
- 每张牌出现在每个位置的概率相等
- 性能高效
- 实现简单

#### 4.1.2 牌型识别算法

**算法**: 组合遍历 + 贪心选择

**核心函数**: `getMaxPoint(cards: poke[]): PokeData`

**流程**:
```
1. 排序: 按点数降序,花色权重降序
2. 遍历所有3张牌组合 (C(5,3) = 10种)
3. 对每个组合:
   a. 检查3张牌之和是否为10的倍数
   b. 如果是,计算剩余2张牌之和的个位数(牛点)
   c. 记录最大单牌和花色
4. 选择牛点最大的组合
5. 如果牛点相同,选择最大单牌最大的组合
6. 如果没有找到有效组合,返回无牛
```

**复杂度分析**:
- 时间复杂度: O(1) - 固定10种组合
- 空间复杂度: O(1) - 常数空间

**代码位置**: `pages/card_game/card_game.ts:477-559`

#### 4.1.3 特殊牌型识别

**炸弹识别**:
```typescript
function isBoom(cards: poke[]): boolean {
  const uniqueNumbers = new Set(cards.map(c => c.number));
  return uniqueNumbers.size === 2;
}
```

**五小牛识别** (待实现):
```typescript
function isFiveSmall(cards: poke[]): boolean {
  const sum = cards.reduce((acc, card) => acc + card.number, 0);
  return sum <= 10;
}
```

**五花牛识别** (待实现):
```typescript
function isFiveFlower(cards: poke[]): boolean {
  return cards.every(card => card.number >= 11);
}
```

### 4.2 比牌逻辑

**比较规则优先级**:
```typescript
function compareHands(hand1: PokeData, hand2: PokeData): number {
  // 1. 特殊牌型等级比较
  const specialLevel1 = getSpecialLevel(hand1);
  const specialLevel2 = getSpecialLevel(hand2);
  if (specialLevel1 !== specialLevel2) {
    return specialLevel1 - specialLevel2;
  }
  
  // 2. 牛点数比较
  if (hand1.pointNumber !== hand2.pointNumber) {
    return hand1.pointNumber - hand2.pointNumber;
  }
  
  // 3. 最大单牌比较
  if (hand1.maxNumber !== hand2.maxNumber) {
    return hand1.maxNumber - hand2.maxNumber;
  }
  
  // 4. 花色比较
  const suitWeight = { 'Spade': 4, 'Heart': 3, 'Club': 2, 'Diamond': 1 };
  return suitWeight[hand1.suit] - suitWeight[hand2.suit];
}

function getSpecialLevel(hand: PokeData): number {
  if (hand.isFiveSmall) return 7;    // 五小牛
  if (hand.isFiveFlower) return 6;   // 五花牛
  if (hand.isBoom) return 3;         // 炸弹
  if (hand.pointNumber === 10) return 5; // 牛牛
  if (hand.hasNiu) return 2;         // 有牛
  return 1;                          // 无牛
}
```

### 4.3 结算逻辑

**公式**:
```typescript
function calculateWinnings(
  banker: player, 
  player: player, 
  bankerHand: PokeData, 
  playerHand: PokeData
): number {
  const result = compareHands(playerHand, bankerHand);
  
  if (result > 0) {
    // 闲家赢
    const multiplier = getMultiplier(playerHand);
    return player.bet * multiplier;
  } else if (result < 0) {
    // 庄家赢
    const multiplier = getMultiplier(bankerHand);
    return -player.bet * multiplier;
  } else {
    // 平局
    return 0;
  }
}

function getMultiplier(hand: PokeData): number {
  if (hand.isFiveSmall) return 7;
  if (hand.isFiveFlower) return 6;
  if (hand.pointNumber === 10) return 5;
  if (hand.pointNumber === 9) return 4;
  if (hand.pointNumber === 8) return 4;
  if (hand.pointNumber >= 7) return 3;
  if (hand.isBoom) return 3;
  return 1;
}
```

---

## 5. 通信架构

### 5.1 HTTP通信

**协议**: HTTPS

**请求格式**:
```json
{
  "userId": 1001,
  "roomNumber": "456789"
}
```

**响应格式**:
```json
{
  "code": 200,
  "msg": "成功",
  "data": {
    // 业务数据
  }
}
```

**状态码**:
- 200: 成功
- 400: 参数错误
- 401: 未授权
- 404: 资源不存在
- 500: 服务器错误

### 5.2 WebSocket通信 (待实现)

**用途**: 实时游戏状态同步

**连接流程**:
```
1. 用户登录成功后建立WebSocket连接
2. 发送认证消息 { type: 'auth', token: 'xxx' }
3. 服务端验证token
4. 连接成功,开始接收消息
```

**消息类型**:
```typescript
interface WSMessage {
  type: string;
  data: any;
  timestamp: number;
}

// 消息类型
type MessageType = 
  | 'auth'           // 认证
  | 'join_room'      // 加入房间
  | 'leave_room'     // 离开房间
  | 'player_ready'   // 玩家准备
  | 'game_start'     // 游戏开始
  | 'deal_cards'     // 发牌
  | 'show_cards'     // 亮牌
  | 'settlement'     // 结算
  | 'chat'           // 聊天
  | 'heartbeat';     // 心跳
```

**消息示例**:
```json
// 玩家准备
{
  "type": "player_ready",
  "data": {
    "roomId": 1703056000123,
    "userId": 1001,
    "status": 2,
    "bet": 5
  },
  "timestamp": 1703056123456
}

// 发牌通知
{
  "type": "deal_cards",
  "data": {
    "roomId": 1703056000123,
    "cards": [
      {
        "userId": 1001,
        "pokers": [...]
      }
    ]
  },
  "timestamp": 1703056123456
}
```

**心跳机制**:
- 客户端每30秒发送心跳包
- 服务端响应pong
- 超过3次未响应视为断线

**断线重连**:
```typescript
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 3;
const RECONNECT_INTERVAL = 3000;

function reconnect() {
  if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
    setTimeout(() => {
      reconnectAttempts++;
      connect();
    }, RECONNECT_INTERVAL);
  } else {
    showError('连接失败,请检查网络');
  }
}
```

---

## 6. 状态管理

### 6.1 状态分类

**全局状态** (app.ts):
```typescript
interface AppState {
  globalData: {
    userInfo: userInfo | null;
    token: string;
    isLogin: boolean;
  }
}
```

**页面状态** (page.data):
- 页面级数据
- 生命周期内有效
- 不跨页面共享

**组件状态** (component.data):
- 组件级数据
- 仅组件内使用

**持久化状态** (LocalStorage):
- 需要持久化的数据
- 跨会话保留

### 6.2 状态同步策略

**单页面内同步**:
```typescript
this.setData({ key: value })  // 同步到视图
```

**跨页面同步**:
```typescript
// 方式1: 通过LocalStorage
setUserInfo(userInfo)
const userInfo = getUserInfo()

// 方式2: 通过URL参数
wx.navigateTo({
  url: `/pages/detail/detail?id=${id}`
})

// 方式3: 通过全局变量
getApp().globalData.xxx = value
```

**组件间同步**:
```typescript
// 父→子: properties
<child-component prop="{{value}}"></child-component>

// 子→父: events
this.triggerEvent('change', { value })
```

---

## 7. 性能优化

### 7.1 代码层面优化

**1. 按需加载**:
```json
{
  "lazyCodeLoading": "requiredComponents"
}
```

**2. 分包加载**:
```json
{
  "subpackages": [
    {
      "root": "packageA",
      "pages": ["pages/game/game"]
    }
  ]
}
```

**3. 图片优化**:
- 使用WebP格式
- 压缩图片质量
- 使用CDN加载

**4. 避免频繁setData**:
```typescript
// Bad
for (let i = 0; i < 100; i++) {
  this.setData({ count: i })
}

// Good
let data = {};
for (let i = 0; i < 100; i++) {
  data[`list[${i}]`] = value;
}
this.setData(data);
```

### 7.2 网络优化

**1. 请求合并**:
```typescript
// 合并多个API为一个
async function initPage() {
  const [userInfo, roomInfo] = await Promise.all([
    getUserInfo(),
    getRoomInfo()
  ]);
}
```

**2. 缓存策略**:
```typescript
// 缓存静态资源
wx.setStorage({
  key: 'cardImages',
  data: images,
  expire: 7 * 24 * 3600 * 1000  // 7天
});
```

**3. 预加载**:
```typescript
// 预加载下一页
wx.prefetch({
  url: '/pages/game/game'
});
```

### 7.3 渲染优化

**1. 虚拟列表**:
```xml
<recycle-view batch="{{batchSetRecycleData}}" height="{{height}}">
  <recycle-item wx:for="{{recycleList}}" wx:key="id">
    <!-- item template -->
  </recycle-item>
</recycle-view>
```

**2. wxs优化**:
```xml
<wxs module="utils">
  function format(value) {
    return value.toFixed(2);
  }
  module.exports = { format };
</wxs>

<view>{{utils.format(price)}}</view>
```

---

## 8. 安全架构

### 8.1 前端安全

**1. 数据验证**:
```typescript
function validateRoomNumber(value: string): boolean {
  return /^\d{6}$/.test(value);
}
```

**2. XSS防护**:
```typescript
function escapeHTML(str: string): string {
  return str.replace(/[&<>"']/g, (match) => {
    const escape: Record<string, string> = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    };
    return escape[match];
  });
}
```

**3. 敏感信息处理**:
```typescript
// 不在前端存储敏感信息
// Token加密存储
const encryptedToken = encrypt(token);
wx.setStorageSync('token', encryptedToken);
```

### 8.2 接口安全

**1. Token认证**:
```typescript
// 请求头添加token
header: {
  'Authorization': `Bearer ${token}`
}
```

**2. 签名验证**:
```typescript
function generateSignature(params: any, secret: string): string {
  const sorted = Object.keys(params).sort().map(k => `${k}=${params[k]}`).join('&');
  return md5(sorted + secret);
}
```

**3. 防重放攻击**:
```typescript
// 添加时间戳和nonce
{
  timestamp: Date.now(),
  nonce: generateNonce(),
  signature: sign(data)
}
```

---

## 9. 测试架构

### 9.1 单元测试

**工具**: Jest

**测试文件组织**:
```
__tests__/
├── utils/
│   ├── game.test.ts
│   └── request.test.ts
└── components/
    └── room-modal.test.ts
```

**测试示例**:
```typescript
describe('getMaxPoint', () => {
  it('should return niu 9', () => {
    const cards = [
      { suit: 'Spade', number: 2 },
      { suit: 'Heart', number: 3 },
      { suit: 'Club', number: 5 },
      { suit: 'Diamond', number: 7 },
      { suit: 'Spade', number: 2 }
    ];
    const result = getMaxPoint(cards);
    expect(result.hasNiu).toBe(true);
    expect(result.pointNumber).toBe(9);
  });
});
```

### 9.2 集成测试

**工具**: 微信开发者工具自动化测试

**测试场景**:
- 完整游戏流程
- 多用户交互
- 异常处理

### 9.3 性能测试

**指标**:
- FPS监控
- 内存占用
- 网络请求时间
- 页面加载时间

---

## 10. 部署架构

### 10.1 前端部署

**流程**:
```
开发 → 测试 → 体验版 → 审核 → 正式版
```

**版本管理**:
```json
{
  "version": "1.0.0",
  "description": "初始版本"
}
```

### 10.2 后端部署 (待实现)

**架构**: 微服务架构

```
┌─────────────┐
│   Nginx     │  负载均衡
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
┌──▼───┐ ┌─▼────┐
│ API1 │ │ API2 │  应用服务器
└──┬───┘ └─┬────┘
   │       │
   └───┬───┘
       │
┌──────▼──────┐
│   Redis     │  缓存层
└─────────────┘
       │
┌──────▼──────┐
│   MySQL     │  数据库
└─────────────┘
```

---

**下一步**: 请参阅《项目需求文档-数据模型.md》了解数据库设计
